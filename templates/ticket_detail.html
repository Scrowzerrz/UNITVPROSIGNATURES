{% extends 'layout.html' %}

{% block title %}Ticket #{{ ticket.id }} - Painel Administrativo{% endblock %}

{% block styles %}
<style>
    .chat-container {
        height: 400px;
        overflow-y: auto;
        padding: 1rem;
        background-color: #f8f9fa;
        border-radius: 0.5rem;
    }
    
    .message {
        margin-bottom: 1rem;
        padding: 1rem;
        border-radius: 1rem;
        max-width: 80%;
        position: relative;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    
    .message-user {
        background-color: #e9ecef;
        border-top-left-radius: 0;
    }
    
    .message-admin {
        background-color: #e3f2fd;
        border-top-right-radius: 0;
        text-align: right;
    }
    
    .message-header {
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }
    
    .message-text {
        margin-bottom: 0.5rem;
        word-wrap: break-word;
        white-space: pre-line;
        text-align: left;
    }
    
    .message-time {
        font-size: 0.75rem;
        color: #6c757d;
    }
    
    .message-status {
        animation: pulse 1.5s infinite;
    }
    
    .reply-form {
        background-color: #f8f9fc;
        border-radius: 0.5rem;
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    }
    
    .user-info {
        position: sticky;
        top: 0;
    }
    
    .border-left-info {
        border-left: 0.25rem solid #36b9cc;
    }
    
    @keyframes pulse {
        0% { opacity: 1; }
        50% { opacity: 0.5; }
        100% { opacity: 1; }
    }
    
    .highlight-new {
        animation: highlight 2s ease-in-out;
    }
    
    @keyframes highlight {
        0% { background-color: rgba(255, 193, 7, 0.3); }
        100% { background-color: transparent; }
    }
    
    /* Separador de datas na conversa */
    .date-separator {
        display: flex;
        align-items: center;
        margin: 1.5rem 0;
        color: #6c757d;
    }
    
    .date-separator::before,
    .date-separator::after {
        content: "";
        flex: 1;
        border-bottom: 1px solid #dee2e6;
    }
    
    .date-separator::before {
        margin-right: .5rem;
    }
    
    .date-separator::after {
        margin-left: .5rem;
    }
    
    /* Status de leitura para mensagens do admin */
    .read-status {
        display: inline-flex;
        align-items: center;
        font-size: 0.75rem;
        color: #6c757d;
    }
    
    .read-status i {
        margin-right: 0.25rem;
    }
    
    /* Botão de ação rápida */
    .quick-actions {
        position: sticky;
        bottom: 0;
        background-color: rgba(255, 255, 255, 0.9);
        padding: 0.5rem 0;
        z-index: 1;
        border-top: 1px solid #dee2e6;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <h1 class="h3 mb-0 text-gray-800">
            <i class="fas fa-headset me-2 text-danger"></i>Ticket #{{ ticket.id }} 
            {% if ticket.status == 'open' %}
                <span class="badge bg-success">Aberto</span>
            {% else %}
                <span class="badge bg-secondary">Fechado</span>
            {% endif %}
            
            {% set unread_count = 0 %}
            {% for message in ticket.messages %}
                {% if not message.read and message.from_type == 'user' %}
                    {% set unread_count = unread_count + 1 %}
                {% endif %}
            {% endfor %}
            
            {% if unread_count > 0 %}
                <span class="badge bg-danger ms-2 animate__animated animate__pulse animate__infinite">
                    {{ unread_count }} não lida(s)
                </span>
            {% endif %}
        </h1>
        <div>
            <a href="{{ url_for('support_dashboard') }}" class="btn btn-secondary">
                <i class="fas fa-arrow-left me-2"></i>Voltar
            </a>
            
            {% if ticket.status == 'open' %}
                <div class="btn-group ms-2">
                    <button type="button" class="btn btn-primary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="fas fa-cog me-1"></i> Ações
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li>
                            <button type="button" class="dropdown-item" id="scrollToReplyBtn">
                                <i class="fas fa-reply me-2"></i>Responder
                            </button>
                        </li>
                        <li><hr class="dropdown-divider"></li>
                        <li>
                            <form method="POST" action="{{ url_for('close_support_ticket', ticket_id=ticket.id) }}" id="closeTicketForm">
                                <button type="button" class="dropdown-item text-danger" id="closeTicketBtn">
                                    <i class="fas fa-times me-2"></i>Fechar Ticket
                                </button>
                            </form>
                        </li>
                    </ul>
                </div>
            {% else %}
                <form method="POST" action="{{ url_for('reopen_ticket', ticket_id=ticket.id) }}" class="d-inline">
                    <button type="submit" class="btn btn-warning ms-2">
                        <i class="fas fa-unlock me-2"></i>Reabrir Ticket
                    </button>
                </form>
            {% endif %}
        </div>
    </div>

    <div class="row">
        <div class="col-lg-4">
            <div class="card shadow mb-4 user-info">
                <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="fas fa-user me-2"></i>Informações do Usuário
                    </h6>
                    {% if ticket.username %}
                        <a href="https://t.me/{{ ticket.username }}" target="_blank" class="btn btn-sm btn-outline-primary">
                            <i class="fab fa-telegram"></i> Contatar
                        </a>
                    {% endif %}
                </div>
                <div class="card-body">
                    <div class="text-center mb-4">
                        <div class="avatar-placeholder bg-primary text-white rounded-circle mx-auto mb-3" style="width: 80px; height: 80px; line-height: 80px; font-size: 2rem;">
                            {{ ticket.user_name[0]|upper }}
                        </div>
                        <h5 class="mb-1">{{ ticket.user_name }}</h5>
                        {% if ticket.username %}
                            <div class="text-muted">
                                <a href="https://t.me/{{ ticket.username }}" target="_blank" class="text-decoration-none">
                                    @{{ ticket.username }}
                                </a>
                            </div>
                        {% endif %}
                        <div class="small text-muted">ID: {{ ticket.user_id }}</div>
                    </div>
                    
                    <div class="ticket-details p-3 bg-light rounded mb-3">
                        <h6 class="border-bottom pb-2 mb-3">Detalhes do Ticket</h6>
                        
                        <div class="row mb-2">
                            <div class="col-6 text-muted">ID do Ticket:</div>
                            <div class="col-6 text-end fw-bold">{{ ticket.id }}</div>
                        </div>
                        
                        <div class="row mb-2">
                            <div class="col-6 text-muted">Status:</div>
                            <div class="col-6 text-end">
                                <span class="badge bg-{{ 'success' if ticket.status == 'open' else 'secondary' }}">
                                    {{ 'Aberto' if ticket.status == 'open' else 'Fechado' }}
                                </span>
                            </div>
                        </div>
                        
                        <div class="row mb-2">
                            <div class="col-6 text-muted">Criado em:</div>
                            <div class="col-6 text-end">{{ ticket.created_at|replace("T", " ")|truncate(16, true, "") }}</div>
                        </div>
                        
                        <div class="row mb-2">
                            <div class="col-6 text-muted">Atualizado:</div>
                            <div class="col-6 text-end">{{ ticket.updated_at|replace("T", " ")|truncate(16, true, "") }}</div>
                        </div>
                        
                        {% if ticket.status == 'closed' %}
                        <div class="row mb-2">
                            <div class="col-6 text-muted">Fechado em:</div>
                            <div class="col-6 text-end">{{ ticket.closed_at|replace("T", " ")|truncate(16, true, "") }}</div>
                        </div>
                        
                        <div class="row mb-2">
                            <div class="col-6 text-muted">Fechado por:</div>
                            <div class="col-6 text-end">
                                <span class="badge bg-{{ 'primary' if ticket.closed_by == 'admin' else 'success' }}">
                                    {{ 'Administrador' if ticket.closed_by == 'admin' else 'Usuário' }}
                                </span>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                    
                    <div class="ticket-stats">
                        <h6 class="border-bottom pb-2 mb-3">Estatísticas</h6>
                        
                        <div class="row">
                            <div class="col-6 mb-3">
                                <div class="card border-left-success h-100 py-2">
                                    <div class="card-body p-2">
                                        <div class="row no-gutters align-items-center">
                                            <div class="col-auto me-2">
                                                <i class="fas fa-user text-success"></i>
                                            </div>
                                            <div class="col">
                                                <div class="text-xs font-weight-bold text-success text-uppercase mb-1">Mensagens do Usuário</div>
                                                <div class="h5 mb-0 font-weight-bold">{{ ticket.user_replies }}</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-6 mb-3">
                                <div class="card border-left-primary h-100 py-2">
                                    <div class="card-body p-2">
                                        <div class="row no-gutters align-items-center">
                                            <div class="col-auto me-2">
                                                <i class="fas fa-headset text-primary"></i>
                                            </div>
                                            <div class="col">
                                                <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">Respostas do Admin</div>
                                                <div class="h5 mb-0 font-weight-bold">{{ ticket.admin_replies }}</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-12">
                                <div class="card border-left-info h-100 py-2">
                                    <div class="card-body p-2">
                                        <div class="row no-gutters align-items-center">
                                            <div class="col-auto me-2">
                                                <i class="fas fa-clock text-info"></i>
                                            </div>
                                            <div class="col">
                                                <div class="text-xs font-weight-bold text-info text-uppercase mb-1">Tempo de Resposta</div>
                                                <div class="h5 mb-0 font-weight-bold">
                                                    {% if ticket.messages|length > 1 %}
                                                        {% set first_message = ticket.messages[0] %}
                                                        {% set first_admin_reply_index = -1 %}
                                                        {% for message in ticket.messages %}
                                                            {% if message.from_type == 'admin' %}
                                                                {% set first_admin_reply_index = loop.index0 %}
                                                                {% break %}
                                                            {% endif %}
                                                        {% endfor %}
                                                        
                                                        {% if first_admin_reply_index > 0 %}
                                                            {% set first_admin_reply = ticket.messages[first_admin_reply_index] %}
                                                            {% set first_time = first_message.timestamp|replace("T", " ")|truncate(19, true, "") %}
                                                            {% set reply_time = first_admin_reply.timestamp|replace("T", " ")|truncate(19, true, "") %}
                                                            <span>{{ ((reply_time|int - first_time|int) / 60)|round }} minutos</span>
                                                        {% else %}
                                                            <span>N/A</span>
                                                        {% endif %}
                                                    {% else %}
                                                        <span>N/A</span>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-8">
            <div class="card shadow mb-4">
                <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="fas fa-comments me-2"></i>Conversa
                    </h6>
                    
                    <div class="btn-group">
                        <button type="button" class="btn btn-sm btn-outline-secondary" id="refreshConversation">
                            <i class="fas fa-sync-alt me-1"></i>Atualizar
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="chat-container" id="chatContainer">
                        {% set current_date = None %}
                        {% for message in ticket.messages %}
                            {% set message_date = message.timestamp.split("T")[0] %}
                            
                            {% if current_date != message_date %}
                                <div class="date-separator">
                                    <span>{{ message_date|replace("-", "/") }}</span>
                                </div>
                                {% set current_date = message_date %}
                            {% endif %}
                            
                            <div class="d-flex {{ 'justify-content-end' if message.from_type == 'admin' else 'justify-content-start' }}" id="message-{{ loop.index }}">
                                <div class="message {{ 'message-admin' if message.from_type == 'admin' else 'message-user' }} {{ 'highlight-new' if not message.read and message.from_type == 'user' }}">
                                    <div class="message-header">
                                        <div>
                                            {% if message.from_type == 'admin' %}
                                                <strong class="text-primary">Administrador</strong>
                                            {% else %}
                                                <strong class="text-success">{{ ticket.user_name }}</strong>
                                            {% endif %}
                                            
                                            {% if not message.read and message.from_type == 'user' %}
                                                <span class="badge bg-warning text-dark ms-1 message-status">Não lida</span>
                                            {% endif %}
                                        </div>
                                        
                                        <div class="message-time">
                                            {{ message.timestamp.split("T")[1]|truncate(8, true, "") }}
                                        </div>
                                    </div>
                                    
                                    <div class="message-text">
                                        {{ message.text|urlize|replace('\n', '<br>')|safe }}
                                    </div>
                                    
                                    {% if message.from_type == 'admin' %}
                                        <div class="message-footer d-flex justify-content-end mt-2">
                                            <div class="read-status">
                                                {% if message.read %}
                                                    <i class="fas fa-check-double text-success" title="Lida pelo usuário"></i>
                                                    <span>Lida</span>
                                                {% else %}
                                                    <i class="fas fa-check text-muted" title="Enviada, aguardando leitura"></i>
                                                    <span>Enviada</span>
                                                {% endif %}
                                            </div>
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                    
                    {% if ticket.status == 'open' %}
                    <div class="reply-form mt-4 p-4 border rounded shadow-sm" id="replySection">
                        <h5 class="mb-3 border-bottom pb-2 text-primary">
                            <i class="fas fa-reply me-2"></i>Responder ao Ticket #{{ ticket.id }}
                        </h5>
                        <form method="POST" action="{{ url_for('reply_to_ticket', ticket_id=ticket.id) }}" id="replyForm">
                            <div class="form-group mb-3">
                                <label for="reply_text" class="mb-2 d-flex justify-content-between">
                                    <span><strong>Mensagem de resposta:</strong></span>
                                    <span class="badge bg-info text-white">Via Telegram</span>
                                </label>
                                <textarea 
                                    name="reply_text" 
                                    id="reply_text" 
                                    class="form-control" 
                                    rows="5" 
                                    placeholder="Digite sua resposta ao usuário..." 
                                    required 
                                    autofocus
                                ></textarea>
                                <div class="form-text text-muted mt-2">
                                    <i class="fas fa-info-circle me-1"></i> O usuário receberá esta mensagem exatamente como escrita. Use mensagens claras e objetivas.
                                </div>
                            </div>
                            
                            <div class="alert alert-info mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" value="1" id="closeAfterReply" name="close_after_reply">
                                    <label class="form-check-label fw-bold" for="closeAfterReply">
                                        <i class="fas fa-check-circle me-1"></i> Fechar ticket automaticamente após enviar resposta
                                    </label>
                                </div>
                                <small class="d-block mt-1 ms-4">
                                    O usuário será notificado que o ticket foi fechado junto com sua resposta.
                                </small>
                            </div>
                            
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="btn-group">
                                    <button type="button" class="btn btn-outline-secondary" id="insertTemplateBtn">
                                        <i class="fas fa-clipboard-list me-2"></i>Usar Template
                                    </button>
                                    <button type="button" class="btn btn-outline-warning" id="previewResponseBtn">
                                        <i class="fas fa-eye me-2"></i>Pré-visualizar
                                    </button>
                                </div>
                                
                                <button type="submit" class="btn btn-primary btn-lg px-4">
                                    <i class="fas fa-paper-plane me-2"></i>Enviar Resposta
                                </button>
                            </div>
                        </form>
                    </div>
                    {% else %}
                    <div class="alert alert-warning mt-4">
                        <i class="fas fa-lock me-2"></i> Este ticket está fechado desde <strong>{{ ticket.closed_at|replace("T", " ")|truncate(16, true, "") }}</strong>.
                        <div class="mt-2">
                            <form method="POST" action="{{ url_for('reopen_ticket', ticket_id=ticket.id) }}" class="d-inline">
                                <button type="submit" class="btn btn-warning">
                                    <i class="fas fa-unlock me-2"></i>Reabrir Ticket
                                </button>
                            </form>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    $(document).ready(function() {
        // Rola a conversa automaticamente para a última mensagem
        const scrollToBottom = () => {
            const chatContainer = document.getElementById('chatContainer');
            chatContainer.scrollTop = chatContainer.scrollHeight;
        };
        
        scrollToBottom();
        
        // Templates de resposta comuns
        const responseTemplates = [
            {
                name: "Saudação Padrão",
                text: "Olá! Obrigado por entrar em contato com o suporte da UniTV. Como posso ajudar?"
            },
            {
                name: "Solicitação de Informações",
                text: "Para que eu possa ajudar melhor, poderia fornecer algumas informações adicionais sobre o problema que está enfrentando?"
            },
            {
                name: "Instruções de Pagamento",
                text: "Para realizar o pagamento, siga estas etapas no bot:\n1. Clique em 'Minha Conta'\n2. Selecione 'Escolher Plano'\n3. Escolha o plano desejado\n4. Selecione a forma de pagamento\n5. Siga as instruções na tela"
            },
            {
                name: "Problemas de Login",
                text: "Se estiver tendo problemas para fazer login, tente estas etapas:\n1. Verifique se suas credenciais estão corretas\n2. Certifique-se de que seu plano está ativo\n3. Tente limpar o cache do aplicativo\n4. Reinicie o dispositivo\n\nSe o problema persistir, nos informe para verificarmos."
            },
            {
                name: "Confirmação de Resolução",
                text: "Seu problema foi resolvido! Se precisar de mais alguma coisa, não hesite em entrar em contato novamente."
            },
            {
                name: "Atraso na Resposta",
                text: "Peço desculpas pelo atraso na resposta. Estamos verificando sua solicitação e retornaremos em breve com mais informações."
            }
        ];
        
        // Gerencia o botão de template
        $('#insertTemplateBtn').click(function() {
            // Cria o modal de seleção de template
            const modalHTML = `
                <div class="modal fade" id="templateModal" tabindex="-1" aria-labelledby="templateModalLabel" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="templateModalLabel">Selecionar Template de Resposta</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <div class="form-group mb-3">
                                    <input type="text" class="form-control" id="templateSearch" placeholder="Buscar template...">
                                </div>
                                <div class="list-group" id="templateList">
                                    ${responseTemplates.map((template, index) => 
                                        `<button type="button" class="list-group-item list-group-item-action template-item" 
                                         data-index="${index}">
                                            <strong>${template.name}</strong>
                                            <div class="small text-muted">${template.text.substring(0, 60)}...</div>
                                        </button>`
                                    ).join('')}
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Adiciona o modal ao corpo do documento
            $('body').append(modalHTML);
            
            // Exibe o modal
            const templateModal = new bootstrap.Modal(document.getElementById('templateModal'));
            templateModal.show();
            
            // Busca de templates
            $('#templateSearch').on('input', function() {
                const searchTerm = $(this).val().toLowerCase();
                $('.template-item').each(function() {
                    const index = $(this).data('index');
                    const template = responseTemplates[index];
                    const templateText = template.name.toLowerCase() + ' ' + template.text.toLowerCase();
                    
                    if (templateText.includes(searchTerm)) {
                        $(this).show();
                    } else {
                        $(this).hide();
                    }
                });
            });
            
            // Gerencia a seleção de um template
            $('.template-item').click(function() {
                const index = $(this).data('index');
                const templateText = responseTemplates[index].text;
                
                // Insere o texto do template no campo de resposta
                $('#reply_text').val(templateText);
                
                // Fecha o modal
                templateModal.hide();
                
                // Remove o modal do DOM após fechamento
                $('#templateModal').on('hidden.bs.modal', function () {
                    $(this).remove();
                });
                
                // Foca no campo de texto para edição
                $('#reply_text').focus();
            });
        });
        
        // Confirma fechamento do ticket
        $('#closeTicketBtn').click(function() {
            if (confirm('Tem certeza que deseja fechar este ticket? O usuário não poderá enviar novas mensagens.')) {
                $('#closeTicketForm').submit();
            }
        });
        
        // Rola até o formulário de resposta
        $('#scrollToReplyBtn').click(function() {
            $('html, body').animate({
                scrollTop: $('#replySection').offset().top - 100
            }, 500);
            $('#reply_text').focus();
        });
        
        // Atualizar conversa (simulado - em produção, faria uma chamada AJAX)
        $('#refreshConversation').click(function() {
            location.reload();
        });
        
        // Pré-visualização da resposta
        $('#previewResponseBtn').click(function() {
            const responseText = $('#reply_text').val();
            const ticketId = '{{ ticket.id }}';
            const closeAfterReply = $('#closeAfterReply').is(':checked');
            
            if (!responseText.trim()) {
                alert('Por favor, escreva uma resposta antes de pré-visualizar.');
                $('#reply_text').focus();
                return;
            }
            
            // Cria o modal de pré-visualização
            const previewModalHTML = `
                <div class="modal fade" id="previewModal" tabindex="-1" aria-labelledby="previewModalLabel" aria-hidden="true">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header bg-primary text-white">
                                <h5 class="modal-title" id="previewModalLabel">
                                    <i class="fas fa-eye me-2"></i>Pré-visualização da Resposta
                                </h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <div class="alert alert-info mb-3">
                                    <i class="fas fa-info-circle me-2"></i>Esta é uma pré-visualização de como o usuário verá sua mensagem no Telegram.
                                </div>
                                
                                <div class="card shadow-sm mb-4">
                                    <div class="card-header bg-primary bg-opacity-10 d-flex justify-content-between align-items-center">
                                        <div>
                                            <strong>Ticket #${ticketId}</strong>
                                            <span class="badge ${ closeAfterReply ? 'bg-danger' : 'bg-success' } ms-2">
                                                ${ closeAfterReply ? 'Será fechado' : 'Permanecerá aberto' }
                                            </span>
                                        </div>
                                        <div class="text-muted small">
                                            ${new Date().toLocaleString('pt-BR')}
                                        </div>
                                    </div>
                                    <div class="card-body">
                                        <div class="mb-3">
                                            <strong class="text-primary">Mensagem que será enviada:</strong>
                                        </div>
                                        <div class="border rounded p-3 bg-light">
                                            <pre class="mb-0" style="white-space: pre-wrap; word-break: break-word;">${responseText}</pre>
                                        </div>
                                        
                                        ${closeAfterReply ? 
                                            `<div class="mt-3 border-top pt-3">
                                                <div class="text-danger fw-bold">
                                                    <i class="fas fa-info-circle me-2"></i>Notificação adicional:
                                                </div>
                                                <div>Este ticket será fechado automaticamente após o envio da resposta.</div>
                                            </div>` 
                                        : ''}
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                                <button type="button" class="btn btn-primary" id="sendFromPreview">
                                    <i class="fas fa-paper-plane me-2"></i>Enviar Resposta
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Adiciona o modal ao corpo do documento
            $('body').append(previewModalHTML);
            
            // Exibe o modal
            const previewModal = new bootstrap.Modal(document.getElementById('previewModal'));
            previewModal.show();
            
            // Botão de envio no modal
            $('#sendFromPreview').click(function() {
                $('#replyForm').submit();
            });
            
            // Remove o modal do DOM após fechamento
            $('#previewModal').on('hidden.bs.modal', function () {
                $(this).remove();
            });
        });
    });
</script>
{% endblock %}